{% extends "base.html" %}

{% block title %}AI –î–µ—Ä–µ–≤–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–π{% endblock %}

{% block content %}
<div class="tree-container">
  <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ -->
  <button id="startBtn">üöÄ –ù–∞—á–∞—Ç—å</button>

  <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è –¥–µ—Ä–µ–≤–∞ -->
  <div class="tree-area" id="treeArea">
    <svg class="tree-svg" id="treeSVG"></svg>
  </div>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
  <div id="resultBox"></div>

  <!-- –í–∞–∫–∞–Ω—Å–∏–∏ -->
  <div id="vacanciesBox"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log("tree-svg.js –ø–æ–¥–∫–ª—é—á–µ–Ω ‚úÖ");

class CareerTree {
  constructor() {
    this.startBtn = document.getElementById("startBtn");
    this.treeArea = document.getElementById("treeArea");
    this.resultBox = document.getElementById("resultBox");
    this.vacanciesBox = document.getElementById("vacanciesBox");

    this.path = [];
    this.maxQuestions = 10;

    if (this.startBtn) {
      this.startBtn.addEventListener("click", () => this.startJourney());
    }
  }

  startJourney() {
    this.startBtn.style.display = "none";
    this.fetchNextNode();
  }

  async fetchNextNode() {
    try {
      const response = await fetch("/ai-tree/api/node", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path: this.path })
      });

      if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);

      const data = await response.json();
      this.renderQuestion(data.question, data.options);

    } catch (err) {
      console.error(err);
      this.showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å");
    }
  }

  renderQuestion(question, options) {
    const qBox = document.createElement("div");
    qBox.className = "question-box fade-in";

    const qText = document.createElement("h3");
    qText.textContent = question;
    qBox.appendChild(qText);

    options.forEach(option => {
      const btn = document.createElement("button");
      btn.className = "tree-option-btn";
      btn.textContent = option;

      btn.addEventListener("click", () => {
        this.handleAnswer(question, option, btn, qBox);
      });

      qBox.appendChild(btn);
    });

    this.treeArea.appendChild(qBox);

    // –°–∫—Ä–æ–ª–ª —Å —É—á—ë—Ç–æ–º —Ö—ç–¥—ç—Ä–∞
    const headerOffset = 80;
    const elementPosition = qBox.getBoundingClientRect().top + window.scrollY;
    const offsetPosition = elementPosition - headerOffset;

    window.scrollTo({ top: offsetPosition, behavior: "smooth" });
  }

  async handleAnswer(question, answer, selectedBtn, qBox) {
    this.path.push({ question, answer });
    selectedBtn.classList.add("selected");

    const btns = qBox.querySelectorAll("button");
    btns.forEach(b => { b.disabled = true; });

    setTimeout(() => {
      if (this.path.length >= this.maxQuestions) {
        this.fetchResult();
      } else {
        this.fetchNextNode();
      }
    }, 700);
  }

  async fetchResult() {
    try {
      const [professionData, vacanciesData] = await Promise.all([
        this.fetchProfession(),
        this.fetchVacancies()
      ]);
      this.displayResult(professionData.profession);
      this.displayVacancies(vacanciesData.vacancies);
    } catch (err) {
      console.error(err);
      this.showError("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞");
    }
  }

  async fetchProfession() {
    const response = await fetch("/ai-tree/api/result", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ path: this.path })
    });
    return await response.json();
  }

  async fetchVacancies() {
    const profession = this.path[this.path.length - 1]?.answer || "";
    const response = await fetch("/ai-tree/api/vacancies", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ profession })
    });
    return await response.json();
  }

  displayResult(profession) {
    this.resultBox.innerHTML = `<h2>–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h2><p>${profession}</p>`;
    this.resultBox.classList.add("show");
    this.resultBox.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  displayVacancies(vacancies) {
    if (!vacancies || vacancies.length === 0) {
      this.vacanciesBox.innerHTML = "<h3>–í–∞–∫–∞–Ω—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>";
      return;
    }
    this.vacanciesBox.innerHTML = `
      <h3>–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏</h3>
      <ul class="vacancies-list">
        ${vacancies.map(v => `
          <li class="vacancy-item">
            <a href="${v.url}" target="_blank">${v.name}</a> ‚Äî ${v.company}
            (${v.salary || "–∑/–ø –Ω–µ —É–∫–∞–∑–∞–Ω–∞"})
          </li>
        `).join("")}
      </ul>
    `;
    this.vacanciesBox.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  showError(msg) {
    const div = document.createElement("div");
    div.className = "error-message";
    div.textContent = msg;
    this.treeArea.appendChild(div);
    setTimeout(() => div.remove(), 4000);
  }
}

document.addEventListener("DOMContentLoaded", () => new CareerTree());
</script>
{% endblock %}
